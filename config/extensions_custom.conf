; extensions.conf - the Asterisk dial plan
;
; Static extension configuration file, used by
; the pbx_config module. This is where you configure all your
; inbound and outbound calls in Asterisk.
;
; This configuration file is reloaded
; - With the "dialplan reload" command in the CLI
; - With the "reload" command (that reloads everything) in the CLI

;
; The "General" category is for certain variables.
;
[general]
static=yes
writeprotect=no
clearglobalvars=no

[default]
exten => 1234,1,Goto(test-menu,start,1)

[from-sip-external]
exten => meeting,1,Goto(test-menu,start,1)

[from-trunk]
exten => s,1,Goto(test-menu,start,1)

[test-menu]
exten => start,1,Set(LISTENED_TO_RECORD=0)
 same => n,GotoIf($["${DIALSTATUS}" = "ANSWER"]?READID)
 same => n,Answer
 same => n,Wait(1)
 same => n,Set(IDCOUNT=0)
 same => n,GotoIf($[${ISNULL(${CALLERID(num)})}]?NAME)
 same => n,Set(LASTLOGIN=${DB(LASTLOGIN/${CALLERID(num)})})
 same => n,Goto(ID_CHECKED)
 same => n(NAME),Set(LASTLOGIN=${DB(LASTLOGIN/${CALLERID(name)})})
 same => n(ID_CHECKED),GotoIf($[${ISNULL(${LASTLOGIN})}]?WELCOME)
 same => n,GotoIf($[${EPOCH} - ${LASTLOGIN} > 1200]?WELCOME)
 same => n,Set(LASTLOGIN_CONG=${DB(LASTLOGIN_CONG/${CALLERID(num)})})
 same => n,GotoIf($[${ISNULL(${LASTLOGIN_CONG})}]?WELCOME)
 same => n,Set(LASTLOGIN_PIN=${DB(LASTLOGIN_PIN/${CALLERID(num)})})
 same => n,GotoIf($[${ISNULL(${LASTLOGIN_PIN})}]?WELCOME)
 same => n, Goto(${LASTLOGIN_CONG},1)
 same => n(RECONNECT),Set(TEST=${DB_DELETE(LASTLOGIN/${CALLERID(num)})})
 same => n,Set(TEST=${DB_DELETE(LOGGEDIN/${PIN})})
 same => n,Set(TEST=${DB_DELETE(LASTLOGIN_CONG/${CALLERID(num)})})
 same => n,Set(TEST=${DB_DELETE(LASTLOGIN_PIN/${CALLERID(num)})})
 same => n,Set(LASTLOGIN=${DB(LASTLOGIN/${CALLERID(num)})})
 same => n,Set(LASTLOGIN_CONG=${DB(LASTLOGIN_CONG/${CALLERID(num)})})
 same => n,Set(LASTLOGIN_PIN=${DB(LASTLOGIN_PIN/${CALLERID(num)})})
 same => n(WELCOME),Playback(grg/welcome)
 same => n(READID),Playback(grg/please_enter_id)
 same => n, WaitExten(10)
 
exten => grg-id,1, Set(MEETING_STARTED_BY_ADMIN=0)
 same => n,Set(PINCOUNT=0)
 same => n,GotoIf($[${ISNULL(${LASTLOGIN_PIN})}]?START)
 same => n,Set(PIN=${LASTLOGIN_PIN})
 same => n,Goto(CHECK)
 same => n(START),GotoIf($["${DIALSTATUS}" = "ANSWER"]?READPIN)
 same => n,Answer
 same => n,Wait(1)
 same => n(READPIN),Read(PIN,grg/please_enter_pin,,,,15)
 same => n,GotoIf($[x${PIN} = x${ADMIN_PIN}]?ADMIN)
 same => n(CHECK),Set(GRG_USER=${DB(${CURRENT_CONG}/${PIN})})
 same => n,Set(GRG_LOGGEDIN=${DB(LOGGEDIN/${PIN})})
 same => n,GotoIf($[${ISNULL(${GRG_USER})}]?BADTRY)
 same => n,GotoIf($[${ISNULL(${GRG_LOGGEDIN})}]?LOGIN)
 same => n,Playback(grg/pin_used)
  same => n,Set(PIN=0)
 same => n,Goto(quit,1)
 same => n(LOGIN),Set(DB(LOGGEDIN/${PIN})=${CALLERID(num)})
 same => n,Set(DB(LASTLOGIN/${CALLERID(num)})=${EPOCH})
 same => n,Set(DB(LASTLOGIN_CONG/${CALLERID(num)})=${CURRENT_CONF})
 same => n,Set(DB(LASTLOGIN_PIN/${CALLERID(num)})=${PIN})
 same => n,Set(CALLERID(name)=${GRG_USER})
 same => n,Goto(grg-pre,2)
 same => n(BADTRY),Set(PINCOUNT=$[${PINCOUNT}+1])
 same => n,GotoIf($[${PINCOUNT}>2]?wrongpass,1)
 same => n,Playback(grg/wrong_pin)
 same => n,Goto(READPIN)
 same => n(ADMIN),Goto(grg-meetme,start,ADMIN)

exten => grg-pre,1,Wait(1)
 same => n,Read(NB,grg/press_all,1)
 same =>  n,GotoIf($[x${NB} = x1]?LIVE)
 same =>  n,GotoIf($[x${NB} = x2]?OLD)
 same =>  n,GotoIf($[x${NB} = x0]?start,RECONNECT)
 same => n,Goto(2)
 same => n(LIVE),Goto(grg-meetme,start,USER)
 same => n(OLD),Set(TESTREC=${DB(${CURRENT_CONG}/admin)})
 same => n,GotoIf($[${ISNULL(${TESTREC})}]?NOREC)
 same => n,Playback(grg/meeting_no_listen)
 same => n,Playback(grg/please_choose_opt1)
 same => n, Goto(2)
 same => n(NOREC),Playback(grg/press_star)
 same => n,Set(LISTENED_TO_RECORD=1)
 same => n,TrySystem(wget -q -O /dev/null "http://localhost/kh-live/listener_joined.php?action=phone_add&type=phone_record&cong=${CURRENT_CONG}&client=${URIENCODE(${GRG_USER})}")
 same => n,ControlPlayback(/var/spool/asterisk/meetme/${CURRENT_CONG}_latest,60000,#,*,,0)
 same => n,Set(TESTREC=${DB(${CURRENT_CONG}/admin)})
 same => n,GotoIf($[${ISNULL(${TESTREC})}]?END_REC)
 same => n,TrySystem(wget -q -O /dev/null "http://localhost/kh-live/listener_left.php?action=phone_remove&type=phone_record&cong=${CURRENT_CONG}&client=${URIENCODE(${GRG_USER})}")
 same => n,Playback(grg/new_meeting_no_record)
 same => n,Playback(grg/please_choose_opt1)
 same => n, Goto(2)
 same => n(END_REC),Playback(grg/thanks_listening)
 same => n, Goto(quit,1)

exten => i,1,WaitExten(5)
 same => n,Set(IDCOUNT=$[${IDCOUNT}+1])
 same => n,GotoIf($[${IDCOUNT}>2]?quit,1)
 same => n,Playback(grg/please_type_id_correctly)
 same => n,Wait(1)
 same => n,Goto(start,READID)

exten => t,1,Set(IDCOUNT=$[${IDCOUNT}+1])
 same => n,GotoIf($[${IDCOUNT}>2]?quit,1)
 same => n,Playback(grg/please_type_id_correctly)
 same => n,Wait(1)
 same => n,Goto(start,READID)

;this extension is only to catch things after the call has been hung up -> user is gone cant ear anything
exten => h,1,GotoIf($[${ISNULL(${GRG_USER})}]?NOTLOGGEDIN)
 same => n,Set(TEST=${DB_DELETE(LOGGEDIN/${PIN})})
 same => n, GotoIf($[${LISTENED_TO_RECORD}=1]?RECORDQUIT)
 same => n(NOTLOGGEDIN),Hangup
 same => n(RECORDQUIT),TrySystem(wget -q -O /dev/null "http://localhost/kh-live/listener_left.php?action=phone_remove&type=phone_record&cong=${CURRENT_CONG}&client=${URIENCODE(${GRG_USER})}")
 same => n,Hangup
 
exten => wrongpass,1,Playback(grg/wrong_pin_3x)
 same =>n, Wait(1)
 same => n,Playback(grg/goodbye)
 same => n,Hangup
 
exten => quit,1,Playback(grg/goodbye)
 same => n,Hangup
 
[grg-meetme]
exten => start,1,Wait(1)
 same => n(ADMIN), Set(MEETME_OPTS=aAwqM)
 same => n,GotoIf($[${LEN(${DB(Testing_0/${CURRENT_CONG})})}>0]?SKIP_REC)
 same => n, Set(MEETME_OPTS=aAwqMr)
 same => n(SKIP_REC),Set(MEETME_ROOMNUM=${CURRENT_CONF})
 same => n,Set(MEETME_RECORDINGFORMAT=wav)
 same => n, Set(MEETME_RECORDINGFILE=${CURRENT_CONG}_latest)
 same => n, Set(MEETING_STARTED_BY_ADMIN=1)
 same => n,Set(CONFPIN=${ADMIN_PIN})
 same => n, Set(ADMINDB=${DB(${CURRENT_CONG}/admin)})
 same => n,Set(ADMIN_KICKED_OUT=0)
 same => n, GotoIf($[${ISNULL(${ADMINDB})}]?NOADMIN)
 ;we dont want to play those sounds they might be heard at the meeting
 ;same => n,Playback(grg/admin_meeting)
 ;same => n,Playback(grg/goodbye)
 same => n,Set(ADMIN_KICKED_OUT=1)
 same => n, Hangup()
 same => n(NOADMIN), Set(DB(${CURRENT_CONG}/admin)=1)
 same => n,TrySystem(cp /var/www/kh-live/config/stream_${CURRENT_CONG}.call /var/spool/asterisk/outgoing/)
 same => n,TrySystem(echo live > /dev/shm/meeting_${CURRENT_CONG})
 same => n,Goto(STARTMEETME,1)
 same => n(USER),Set(ADMINDB=${DB(${CURRENT_CONG}/admin)})
 same => n,Set(CONFPIN=${USER_PIN})
 same => n,Set(MEETME_ROOMNUM=${CURRENT_CONF})
 same => n,GotoIf($[${ISNULL(${ADMINDB})}]?NOTREADY)
 same => n,Set(MEETME_OPTS=wqMmX)
 same => n,Playback(grg/meeting_start)
 same => n,Playback(grg/press_4)
 same => n,TrySystem(wget -q -O /dev/null "http://localhost/kh-live/listener_joined.php?action=phone_add&type=phone_live&cong=${CURRENT_CONG}&client=${URIENCODE(${GRG_USER})}&confid=${CURRENT_CONF}")
 same => n,Goto(STARTMEETME,1)
 same => n(NOTREADY),Playback(grg/please_wait)
 same => n,Wait(5)
 same => n,Playback(grg/automatic_connect)
 same => n,Wait(5)
 same => n,Goto(USER)

exten =>h,1,GotoIf($[${MEETING_STARTED_BY_ADMIN}=1]?ADMINQUIT)
 same => n,Set(TEST=${DB_DELETE(LOGGEDIN/${PIN})})
 same => n,TrySystem(wget -q -O /dev/null "http://localhost/kh-live/listener_left.php?action=phone_remove&type=phone_live&cong=${CURRENT_CONG}&client=${URIENCODE(${GRG_USER})}")
 same => n,Hangup()
 same => n(ADMINQUIT),GotoIf($[${ADMIN_KICKED_OUT}=1]?ADMIN_KICK_OUT)
 same => n,Set(TEST=${DB_DELETE(${CURRENT_CONG}/admin)})
 same => n,GotoIf($[${LEN(${DB_DELETE(Testing_0/${CURRENT_CONG})})}>0]?SKIP_RECORD)
 same => n,TrySystem(/usr/bin/lame -f -b 16 -m m -S /var/spool/asterisk/meetme/${CURRENT_CONG}_latest.wav /var/www/kh-live/records/${CURRENT_CONG}-${STRFTIME(${NOW},,%Y%m%d)}_${STRFTIME(${NOW},,%H%M%S)}.mp3)
 same => n(SKIP_RECORD),TrySystem(echo down > /dev/shm/meeting_${CURRENT_CONG})
 same => n,Hangup()
 same => n(ADMIN_KICK_OUT),Set(ADMIN_KICKED_OUT=0)
 same => n,Hangup()

exten => STARTMEETME,1,Set(CHANNEL(musicclass)=grg-music)
 same => n,MeetMe(${MEETME_ROOMNUM},${MEETME_OPTS},${CONFPIN})
 same => n,Hangup()

 exten => killpin,1,Playback(grg/not_authorised)
 same =>n, Wait(1)
 same => n,Playback(grg/goodbye)
 same => n,Hangup

exten => 4,1,TrySystem(wget -q -O /dev/null "http://localhost/kh-live/answer.php?action=request&type=phone_live&cong=${CURRENT_CONG}&client=${URIENCODE(${GRG_USER})}")
 same =>n,Playback(grg/give_answer)
 same => n,Goto(STARTMEETME,1)

exten => 6,1,TrySystem(wget -q -O /dev/null "http://localhost/kh-live/answer.php?action=cancel&type=phone_live&cong=${CURRENT_CONG}&client=${URIENCODE(${GRG_USER})}")
 same => n,Playback(grg/request_stop)
 same => n,Goto(STARTMEETME,1)
 
 ;start_cong-start
[test-menu]
exten => 706527,1,Playback(grg/start_cong)
 same => n,Set(CURRENT_CONG=start_cong)
 same => n,Set(CURRENT_CONF=706527)
 same => n,Set(ADMIN_PIN=69589)
 same => n,Set(USER_PIN=59199)
 same => n,Goto(grg-id,1)
exten => ices_start_cong,1,Answer()
 same => n,Set(LISTENED_TO_RECORD=0)
 same => n,Wait(1)
 same => n,ICES(/var/www/kh-live/config/asterisk-ices-start_cong.xml) 
 same => n,Hangup()
exten => meet_me_start_cong,1,Answer()
 same => n,Set(LISTENED_TO_RECORD=0)
 same => n,Meetme(706527,qlMx,59199)
 same => n,Hangup()
exten => meet_me_start_cong_admin,1,Answer()
 same => n,Set(LISTENED_TO_RECORD=0)
 same => n,Set(CURRENT_CONG=start_cong)
 same => n,Set(CURRENT_CONF=706527)
 same => n,Set(ADMIN_PIN=69589)
 same => n,Goto(grg-meetme,start,ADMIN)
 same => n,Hangup()
exten=> test_meeting_start_cong,1,Answer()
 same => n,Set(CURRENT_CONG=start_cong)
 same => n,Set(DB(Testing_0/start_cong)=1)
 same => n(SOUND),Playback(grg/automatic_connect)
 same => n,Wait(10)
 same => n,Goto(SOUND)
 ;start_cong-stop
 